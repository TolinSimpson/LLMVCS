<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VCS-JS Test Harness</title>
    <style>
      :root {
        color-scheme: dark;
        --bg: #0b1020;
        --panel: #121a33;
        --muted: #92a0c8;
        --text: #e7eeff;
        --border: rgba(255, 255, 255, 0.12);
        --accent: #6aa3ff;
        --danger: #ff6a6a;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: radial-gradient(1200px 700px at 10% 10%, #17214a, var(--bg));
        color: var(--text);
        font: 14px/1.4 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
      }
      .wrap {
        max-width: 1200px;
        margin: 0 auto;
        padding: 16px;
        display: grid;
        grid-template-columns: 1.25fr 0.75fr;
        gap: 12px;
      }
      .card {
        background: color-mix(in srgb, var(--panel) 92%, black);
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.35);
      }
      .card h2 {
        margin: 0;
        padding: 10px 12px;
        font-size: 14px;
        letter-spacing: 0.2px;
        border-bottom: 1px solid var(--border);
        color: var(--muted);
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
      }
      button {
        appearance: none;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        padding: 7px 10px;
        border-radius: 9px;
        cursor: pointer;
      }
      button:hover {
        border-color: rgba(255, 255, 255, 0.25);
      }
      button.primary {
        border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
        background: color-mix(in srgb, var(--accent) 18%, rgba(255, 255, 255, 0.06));
      }
      button.danger {
        border-color: color-mix(in srgb, var(--danger) 55%, var(--border));
        background: color-mix(in srgb, var(--danger) 12%, rgba(255, 255, 255, 0.06));
      }
      .hint {
        color: var(--muted);
        font-size: 12px;
      }
      textarea {
        width: 100%;
        min-height: 360px;
        box-sizing: border-box;
        border: 0;
        outline: none;
        padding: 12px;
        background: transparent;
        color: var(--text);
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
        font-size: 12.5px;
        resize: vertical;
      }
      .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        padding: 10px 12px;
      }
      .kv {
        display: grid;
        grid-template-columns: 110px 1fr;
        gap: 6px 10px;
        align-items: center;
      }
      .kv .k {
        color: var(--muted);
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.05);
        color: var(--muted);
        font-size: 12px;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      }
      .out {
        padding: 10px 12px;
        height: 220px;
        overflow: auto;
        white-space: pre-wrap;
        background: rgba(0, 0, 0, 0.15);
      }
      .regs {
        max-height: 260px;
        overflow: auto;
        padding: 10px 12px;
        border-top: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.12);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }
      th,
      td {
        text-align: left;
        padding: 6px 6px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        vertical-align: top;
      }
      th {
        color: var(--muted);
        font-weight: 600;
      }
      canvas {
        width: 100%;
        height: auto;
        display: block;
        background: #000;
      }
      .footer {
        padding: 10px 12px;
        color: var(--muted);
        border-top: 1px solid var(--border);
        font-size: 12px;
      }
      input[type="number"] {
        width: 92px;
        padding: 6px 8px;
        border-radius: 9px;
        border: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.15);
        color: var(--text);
      }
      select {
        padding: 6px 8px;
        border-radius: 9px;
        border: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.15);
        color: var(--text);
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h2>Script</h2>
        <div class="row">
          <span class="pill">Module 0: <span class="mono">llmvcc-ops</span></span>
          <span class="pill">Module 2: <span class="mono">graphics-ops</span></span>
          <span class="pill">Module 4: <span class="mono">input-ops</span></span>
          <span class="pill">$result supported</span>
          <span style="flex: 1"></span>
          <label class="hint">Example:</label>
          <select id="exampleSelect">
            <option value="pong">Pong (W/S + ↑/↓, R restart)</option>
            <option value="2048">2048 (Arrow keys, R restart)</option>
            <option value="hello">Hello + draw</option>
            <option value="tick">Tick loop (delay)</option>
          </select>
          <button id="loadExampleBtn">Load example</button>
        </div>
        <textarea id="source" spellcheck="false"></textarea>
        <div class="footer">
          Tip: variable references use <span class="mono">$name</span>. Store/load use a quoted name:
          <span class="mono">0.11("x", 10)</span> / <span class="mono">0.12("x")</span>.
        </div>
      </div>

      <div class="card">
        <h2>Run</h2>
        <div class="row">
          <button class="primary" id="compileBtn">Compile</button>
          <button id="startBtn">Start</button>
          <button id="stepBtn">Step</button>
          <button class="primary" id="runBtn">Run</button>
          <button class="primary" id="restartBtn">Restart</button>
          <button class="danger" id="pauseBtn">Pause</button>
          <button class="danger" id="resetBtn">Reset</button>
          <span style="flex: 1"></span>
          <label class="hint">Steps/tick</label>
          <input id="stepsPerTick" type="number" min="1" max="5000" value="250" />
        </div>
        <div class="grid2">
          <div class="kv">
            <div class="k">Program</div>
            <div class="mono" id="progName">-</div>
            <div class="k">Context</div>
            <div class="mono" id="ctxId">-</div>
            <div class="k">State</div>
            <div class="mono" id="ctxState">-</div>
            <div class="k">IP</div>
            <div class="mono" id="ctxIp">-</div>
            <div class="k">StackTop</div>
            <div class="mono" id="ctxStackTop">-</div>
          </div>
          <div class="kv">
            <div class="k">$result</div>
            <div class="mono" id="resultVal">-</div>
            <div class="k">Error</div>
            <div class="mono" id="errorMsg">-</div>
            <div class="k">SleepUntil</div>
            <div class="mono" id="sleepUntil">-</div>
          </div>
        </div>
        <div class="out mono" id="output"></div>
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div class="regs">
          <table>
            <thead>
              <tr>
                <th style="width: 54px">Slot</th>
                <th style="width: 140px">Name</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody id="regsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script src="./vcs.js"></script>
    <script src="./modules/LlmvccOps.js"></script>
    <script src="./modules/GraphicsOps.js"></script>
    <script src="./modules/InputOps.js"></script>
    <script>
      (() => {
        const $ = (id) => document.getElementById(id);

        const elSource = $("source");
        const elOutput = $("output");
        const elRegsBody = $("regsBody");
        const elProgName = $("progName");
        const elCtxId = $("ctxId");
        const elCtxState = $("ctxState");
        const elCtxIp = $("ctxIp");
        const elCtxStackTop = $("ctxStackTop");
        const elResultVal = $("resultVal");
        const elErrorMsg = $("errorMsg");
        const elSleepUntil = $("sleepUntil");
        const elStepsPerTick = $("stepsPerTick");

        const ctxStateName = (s) => {
          switch (s) {
            case ContextState.IDLE:
              return "IDLE";
            case ContextState.RUNNING:
              return "RUNNING";
            case ContextState.PAUSED:
              return "PAUSED";
            case ContextState.STOPPED:
              return "STOPPED";
            case ContextState.ERROR:
              return "ERROR";
            default:
              return String(s);
          }
        };

        let engine = null;
        let programId = -1;
        let contextId = -1;
        let rafHandle = 0;
        let running = false;

        const examples = {
          pong: `// Pong
// Controls:
// - Left paddle: W/S
// - Right paddle: Up/Down
// - Restart: R
//
// Labels are supported: define with \`:name\` and jump with \`@name\`.
//
// Modules:
// - 0 = llmvcc-ops
// - 2 = graphics-ops
// - 4 = input-ops

2.0(800, 600, "PONG - VCS-JS")

:reset
0.11("p1y", 250)
0.11("p2y", 250)
0.11("p1score", 0)
0.11("p2score", 0)
0.11("bx", 392)
0.11("by", 292)
0.11("bvx", 5)
0.11("bvy", 3)

:loop
// Exit if window closed
2.7()
0.6(@exit, $result)

// Restart key (R=82)
4.1(82)
0.5(@reset, $result)

// --- Input (left paddle W/S) ---
4.0(87)            // W
0.6(@p1_down, $result)
0.18($p1y, 8)
0.11("p1y", $result)

:p1_down
4.0(83)            // S
0.6(@p2_up, $result)
0.17($p1y, 8)
0.11("p1y", $result)

// --- Input (right paddle Up/Down) ---
:p2_up
4.0(38)            // Up
0.6(@p2_down, $result)
0.18($p2y, 8)
0.11("p2y", $result)

:p2_down
4.0(40)            // Down
0.6(@clamp_p1_top, $result)
0.17($p2y, 8)
0.11("p2y", $result)

// --- Clamp paddles to screen (0..500) ---
:clamp_p1_top
0.23($p1y, 0)
0.6(@clamp_p1_bot, $result)
0.11("p1y", 0)

:clamp_p1_bot
0.22($p1y, 500)
0.6(@clamp_p2_top, $result)
0.11("p1y", 500)

:clamp_p2_top
0.23($p2y, 0)
0.6(@clamp_p2_bot, $result)
0.11("p2y", 0)

:clamp_p2_bot
0.22($p2y, 500)
0.6(@move_ball, $result)
0.11("p2y", 500)

// --- Ball movement ---
:move_ball
0.17($bx, $bvx)
0.11("bx", $result)
0.17($by, $bvy)
0.11("by", $result)

// --- Wall collisions (top/bottom) ---
0.23($by, 0)
0.6(@wall_bottom, $result)
0.15($bvy, -1)
0.11("bvy", $result)
0.11("by", 0)

:wall_bottom
0.22($by, 585)
0.6(@paddle1, $result)
0.15($bvy, -1)
0.11("bvy", $result)
0.11("by", 585)

// --- Paddle collisions ---
:paddle1
0.23($bx, 55)
0.6(@paddle2, $result)
0.24($by, $p1y)
0.6(@paddle2, $result)
0.17($p1y, 100)
0.25($by, $result)
0.6(@paddle2, $result)
0.15($bvx, -1)
0.11("bvx", $result)
0.11("bx", 55)

:paddle2
0.22($bx, 730)
0.6(@score_left, $result)
0.24($by, $p2y)
0.6(@score_left, $result)
0.17($p2y, 100)
0.25($by, $result)
0.6(@score_left, $result)
0.15($bvx, -1)
0.11("bvx", $result)
0.11("bx", 730)

// --- Scoring ---
:score_left
0.23($bx, 0)
0.6(@score_right, $result)
0.17($p2score, 1)
0.11("p2score", $result)
0.11("bx", 392)
0.11("by", 292)
0.11("bvx", 5)
0.11("bvy", 3)
0.4(@render)

:score_right
0.22($bx, 800)
0.6(@render, $result)
0.17($p1score, 1)
0.11("p1score", $result)
0.11("bx", 392)
0.11("by", 292)
0.11("bvx", -5)
0.11("bvy", 3)

// --- Render ---
:render
2.2(0, 0, 0)
2.3(30, $p1y, 15, 100, 255, 255, 255)
2.3(755, $p2y, 15, 100, 255, 255, 255)
2.3($bx, $by, 15, 15, 255, 255, 255)
2.5("P1", 120, 30, 18, 200, 200, 200)
2.5($p1score, 155, 30, 18, 200, 200, 200)
2.5("P2", 610, 30, 18, 200, 200, 200)
2.5($p2score, 645, 30, 18, 200, 200, 200)
2.6()
2.10(16)
0.4(@loop)

:exit
2.1()
0.1()
`,
          hello: `// Hello + draw
0.13("Hello from VCS-JS")
2.0(800, 600, "VCS-JS Test")
2.2(10, 10, 18)
2.3(40, 60, 120, 80, 90, 160, 255)
2.4(240, 120, 40, 255, 120, 90)
2.5("Use Run/Step/Pause", 40, 30, 18, 240, 240, 240)
2.6()
0.1()
`,
          tick: `// Tick loop with non-blocking delay
2.0(640, 360, "Tick loop")
0.11("t", 0)

// [3] loop start
2.2(0, 0, 0)
2.5("t = ", 20, 20, 18, 200, 200, 200)
2.6()

// t = t + 1
0.17($t, 1)
0.11("t", $result)

// delay 16ms
2.10(16)

// loop
0.4(3)
`,
        };

        function appendOut(line) {
          elOutput.textContent += line + "\n";
          elOutput.scrollTop = elOutput.scrollHeight;
        }

        function formatValue(v) {
          if (!v) return "null";
          switch (v.type) {
            case VType.NULL:
              return "null";
            case VType.INT:
              return String(v.i | 0);
            case VType.FLOAT:
              return String(v.f);
            case VType.BOOL:
              return (v.i | 0) !== 0 ? "true" : "false";
            case VType.STRING:
              return JSON.stringify(engine.strings.get(v.sid));
            case VType.SLOT:
              return `slot(${v.i | 0})`;
            default:
              return "null";
          }
        }

        function refreshUI() {
          if (!engine || contextId < 0) return;
          const ctx = engine.contexts[contextId];
          const prog = programId >= 0 ? engine.programs[programId] : null;
          elProgName.textContent = prog ? `${prog.name} (${prog.inst_count} inst)` : "-";
          elCtxId.textContent = String(contextId);
          elCtxState.textContent = ctxStateName(ctx.state);
          elCtxIp.textContent = String(ctx.ip);
          elCtxStackTop.textContent = String(ctx.stack_top);
          elErrorMsg.textContent = ctx.error_msg ? ctx.error_msg : "-";
          elSleepUntil.textContent = ctx.sleepUntilMs ? String(Math.floor(ctx.sleepUntilMs)) : "-";
          elResultVal.textContent = formatValue(engine.getVar("result"));

          // Registers
          const n = engine.registers.nextSlot;
          const maxShow = 200;
          const rows = [];
          for (let i = 0; i < n && i < maxShow; i++) {
            const name = engine.registers.names[i] || "";
            const val = engine.registers.get(i);
            rows.push(
              `<tr><td class="mono">${i}</td><td class="mono">${escapeHtml(name)}</td><td class="mono">${escapeHtml(
                formatValue(val)
              )}</td></tr>`
            );
          }
          elRegsBody.innerHTML = rows.join("");
        }

        function escapeHtml(s) {
          return String(s)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
        }

        function ensureEngine() {
          engine = new VcsEngine();
          engine.init();

          // Register modules using IDs from existing stacks (0=llmvcc, 2=graphics).
          engine.registerModule(0, new LlmvccOps());
          engine.registerModule(2, new GraphicsOps());
          engine.registerModule(4, new InputOps());
          // Compatibility: some older stacks use 3 for llmvcc.
          engine.registerModule(3, new LlmvccOps());
        }

        function compile() {
          stopRunLoop();
          elOutput.textContent = "";
          ensureEngine();

          programId = engine.loadString(elSource.value, "inline");
          if (programId < 0) {
            appendOut("Compile failed.");
            return;
          }
          contextId = engine.createContext(programId);
          if (contextId < 0) {
            appendOut("Failed to create context.");
            return;
          }

          engine.contexts[contextId].print_fn = (msg) => appendOut(String(msg));
          appendOut(`Compiled OK. programId=${programId}, contextId=${contextId}`);
          refreshUI();
        }

        function start() {
          if (!engine || contextId < 0) return;
          engine.start(contextId);
          refreshUI();
        }

        function stepOnce() {
          if (!engine || contextId < 0) return;
          // Step requires RUNNING; do one step and pause again unless complete.
          engine.start(contextId);
          engine.step(contextId, 1);
          if (engine.contexts[contextId].state === ContextState.RUNNING) engine.pause(contextId);
          refreshUI();
        }

        function runLoop() {
          if (!engine || contextId < 0) return;
          running = true;
          engine.start(contextId);

          const tick = () => {
            if (!running) return;
            const steps = Math.max(1, Math.min(5000, parseInt(elStepsPerTick.value, 10) || 250));
            engine.step(contextId, steps);
            refreshUI();

            const st = engine.contexts[contextId].state;
            if (st === ContextState.RUNNING || st === ContextState.PAUSED) {
              rafHandle = requestAnimationFrame(tick);
            } else {
              running = false;
              rafHandle = 0;
              refreshUI();
            }
          };
          rafHandle = requestAnimationFrame(tick);
        }

        function stopRunLoop() {
          running = false;
          if (rafHandle) cancelAnimationFrame(rafHandle);
          rafHandle = 0;
        }

        function pause() {
          stopRunLoop();
          if (engine && contextId >= 0) engine.pause(contextId);
          refreshUI();
        }

        function reset() {
          stopRunLoop();
          engine = null;
          programId = -1;
          contextId = -1;
          elProgName.textContent = "-";
          elCtxId.textContent = "-";
          elCtxState.textContent = "-";
          elCtxIp.textContent = "-";
          elCtxStackTop.textContent = "-";
          elResultVal.textContent = "-";
          elErrorMsg.textContent = "-";
          elSleepUntil.textContent = "-";
          elRegsBody.innerHTML = "";
          elOutput.textContent = "";
        }

        $("compileBtn").addEventListener("click", compile);
        $("startBtn").addEventListener("click", start);
        $("stepBtn").addEventListener("click", stepOnce);
        $("runBtn").addEventListener("click", runLoop);
        $("restartBtn").addEventListener("click", () => {
          compile();
          runLoop();
        });
        $("pauseBtn").addEventListener("click", pause);
        $("resetBtn").addEventListener("click", reset);

        $("loadExampleBtn").addEventListener("click", async () => {
          const key = $("exampleSelect").value;

          // Prefer inline examples; otherwise load from ./stacks/<name>.vcs.
          // Note: when opened as file://, browsers often block fetch() to local files.
          if (examples[key]) {
            elSource.value = examples[key];
            return;
          }

          const path = `./stacks/${key}.vcs`;
          try {
            const res = await fetch(path, { cache: "no-store" });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            elSource.value = await res.text();
          } catch (e) {
            // Fallback for file:// usage: ask user to pick the .vcs file.
            if (location.protocol === "file:" && globalThis.showOpenFilePicker) {
              try {
                const [handle] = await globalThis.showOpenFilePicker({
                  multiple: false,
                  types: [
                    {
                      description: "VCS stacks",
                      accept: { "text/plain": [".vcs"] },
                    },
                  ],
                });
                const file = await handle.getFile();
                elSource.value = await file.text();
                return;
              } catch (pickErr) {
                // user cancelled or picker not permitted
              }
            }

            appendOut(
              `Failed to load ${path}: ${e && e.message ? e.message : String(e)}\n` +
                `Tip: serve this folder over HTTP (e.g. "python -m http.server" in vcs-js/) or use the file picker fallback.`
            );
            elSource.value = examples.hello;
          }
        });

        // default content
        $("exampleSelect").value = "pong";
        elSource.value = examples.pong;
      })();
    </script>
  </body>
</html>